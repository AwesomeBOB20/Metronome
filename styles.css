@import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@400&display=swap');

/* === Theme === */
:root {
  --black: #000;
  --white: #fff;
  --bg: #1c1c1c;

  /* Oranges */
  --orange: #d35400;
  --orange-d: #c25227;   /* hover */
  --orange-dim: #a84300;

  /* Purple & Blues */
  --purple: #96318d; 
  --purple-d: #81227a; 
  --purple-dim: #752070;
  --blue: #058890;  
  --blue-d: #04767e;   
  --blue-dim: #03656b; 

  --gray-1: #ddd; 
  --gray-3: #53525d;
}

/* === Base === */
* { box-sizing: border-box; }
html, body { 
  font-family: 'Ubuntu', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
  font-weight: 400; 
}
body {
  margin: 0;
  background: var(--bg);
  color: #fff;
  font-size: 18px;
  padding: 0;
}
@media (max-width: 700px) {
  body { padding-top: 0; }
}
.container { 
  width: 92%; 
  max-width: 900px; 
  margin: 16px auto; 
  text-align: center; 
}
.page-center { 
  display: block; 
  min-height: unset; 
  padding: 8px 0; 
}

/* === Buttons (default 40px) === */
.btn {
  height: auto; 
  min-height: 40px; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  border: 2px solid var(--black); 
  color: #fff; 
  font-size: 1.2rem;
  
  /* === ADD THIS LINE === */
  letter-spacing: 0.5px;
  /* ===================== */

  padding: 6px 12px; 
  line-height: 1.15; 
  text-align: center;
  white-space: normal;
  border-radius: 6px; 
  cursor: pointer; 
  user-select: none; 
  -webkit-tap-highlight-color: transparent;
}

.btn--orange { background: var(--orange); }
.btn--orange:hover { background: var(--orange-d); }
.btn--purple { background: var(--purple); }
.btn--purple:hover { background: var(--purple-d); }
.btn:disabled { background: var(--orange-dim); cursor: not-allowed; }
.btn-square { width: 40px; height: 40px; padding: 0; }

/* Focus styles */
.btn:focus-visible,
.selector:focus-visible,
.picker__close:focus-visible {
  outline: 3px solid #fff;
  outline-offset: 2px;
}

/* === Select triggers & Inputs === */
.selector {
  width: auto; 
  min-width: 4rem; 
  flex: 1; 
  max-width: 100%; 
  height: auto; 
  min-height: 40px; 
  padding: 6px 12px; 
  font-size: 1.2rem; 
  line-height: 1.2;
  border: 2px solid var(--black); 
  border-radius: 6px;
  color: #fff; 
  background: var(--orange); 
  text-align: left;
  white-space: normal; 
  overflow: visible;
  display: flex; 
  align-items: center;
  -webkit-user-select: none; 
  user-select: none; 
  caret-color: transparent;
}
.selector--orange { background: var(--orange); }

.visually-hidden {
  position: absolute !important; left: -9999px !important; top: auto !important;
  width: 1px !important; height: 1px !important; overflow: hidden !important;
}

.tempo-input {
  width: 7rem; 
  height: 40px; 
  padding: 6px 12px; 
  font-size: 1.1rem;
  border: 2px solid var(--black); 
  border-radius: 6px;
  background: #fff; 
  color: #000; 
  text-align: center;
}

/* === Labels === */
.metro-label { 
  color: #fff; 
  font-size: 1rem; 
  white-space: nowrap;
}

/* === Sliders === */
.slider-fill {
  --thumb: 24px;
  width: 100%; 
  height: 16px; 
  border-radius: 6px;
  box-shadow: inset 0 0 0 2px var(--black);
  background: linear-gradient(to right, var(--purple) 0 0) no-repeat var(--bg-pos, 0/0%), var(--gray-1);
  -webkit-appearance: none; 
  appearance: none;
}
.slider--orange {
  background: linear-gradient(to right, var(--orange) 0 0) no-repeat var(--bg-pos, 0/0%), var(--gray-1);
}
.slider-fill::-webkit-slider-thumb {
  -webkit-appearance: none; 
  width: var(--thumb); 
  height: var(--thumb);
  background: #fff; 
  border-radius: 50%; 
  border: 2px solid var(--black); 
  cursor: pointer;
}
.slider-fill::-moz-range-thumb {
  width: var(--thumb); 
  height: var(--thumb);
  background: #fff; 
  border-radius: 50%; 
  border: 2px solid var(--black); 
  cursor: pointer;
}

/* iOS Thumb-only fix */
.is-ios .slider-fill { touch-action: manipulation; }
.is-ios .slider-fill::-webkit-slider-runnable-track { pointer-events: none; }
.is-ios .slider-fill::-webkit-slider-thumb { pointer-events: auto; }

/* === Panel & Display === */
.metro-panel { width: 100%; margin: 0 auto; background: transparent; border: none; }
.metro-display { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; }
.bpm-line { display: flex; align-items: center; justify-content: center; gap: 20px; width: auto; }
.bpm-stack { display: flex; flex-direction: column; gap: 10px; }
.metro-bpm { font-size: 8rem; line-height: 1; color: #fff; font-variant-numeric: tabular-nums; }
#metroBpmValue { display: inline-block; padding: 0; border: 0; border-radius: 0; }

@media (max-width: 900px) { .metro-bpm { font-size: 6.2rem; } }
@media (max-width: 700px) { .bpm-line { margin: 10px 0; } }

/* Sections & Cards */
.metro-stack { display: flex; flex-direction: column; gap: 20px; }
.card { 
  padding: 16px; 
  border-radius: 12px; 
  border: 2px solid var(--black); 
  background: var(--blue); 
  box-sizing: border-box; 
  display: flex;
  flex-direction: column;
  gap: 26px;
}

/* === Tempo Row (Card #1) === */
.tempo-row.transport-eq {
  display: flex; flex-wrap: nowrap; align-items: center; gap: 20px; width: 100%;
}
.tempo-row.transport-eq .btn, 
.tempo-row.transport-eq .tempo-input {
  min-width: 7rem;
}
/* Slider wrapper for iOS thumb fix */
.tempo-row.transport-eq .slider-wrap {
  flex: 1 1 auto; 
  min-width: 280px;
}
.tempo-row.transport-eq #metroBpmRange {
  width: 100%;
}

/* Mobile: row1 = Start | BPM Input | Tap, row2 = Slider */
@media (max-width: 700px) {
  .tempo-row.transport-eq {
    display: grid;
    /* Explicitly 3 equal columns */
    grid-template-columns: 1fr 1fr 1fr;
    grid-auto-rows: min-content; 
    gap: 20px; 
    align-items: center; 
    width: 100%;
  }

  /* 1. Start Button -> Col 1 */
  .tempo-row.transport-eq #metroPlay {
    grid-row: 1;
    grid-column: 1;
    width: 100%;
  }

  /* 2. BPM Input -> Col 2 */
  .tempo-row.transport-eq .tempo-input {
    grid-row: 1;
    grid-column: 2;
    width: 100%;
    min-width: 0; /* allows shrinking */
  }

  /* 3. Tap Button -> Col 3 */
  .tempo-row.transport-eq #tapTempoBtn {
    grid-row: 1;
    grid-column: 3;
    width: 100%;
  }

  /* 4. Slider (ID or Wrapper) -> Row 2, Full Width */
  .tempo-row.transport-eq #metroBpmRange,
  .tempo-row.transport-eq .slider-wrap {
    grid-row: 2;
    grid-column: 1 / -1; /* Spans all 3 columns */
    width: 100%;
    min-width: 0;
    margin: 0;
  }
}

/* === Lights (Main) === */
.metro-lights {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  margin: 16px 0px 0px 0px;
}
.main-row {
  display: grid;
  grid-auto-flow: column;
  gap: 20px;
  width: 100%; /* Forces the row to fill the parent */
}

.metro-light {
  height: 48px; 
  border: 3px solid var(--black); 
  border-radius: 16px; 
  background: var(--gray-1);
  transition: transform .05s linear, background .05s linear, filter .05s; 
  cursor: pointer;
}
.metro-light.is-accent { background: var(--purple); }
.metro-light.is-beat { background: var(--orange); }
.metro-light.is-muted { background: var(--blue-dim); opacity: 1; }
.metro-light.is-hit { transform: scale(1.05); filter: brightness(1.3); border-color: #fff; }

/* === Lights (Subdivisions) === */
.metro-lights--subs {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
  margin: 10px auto;
}

/* This is the container generated by JS */
.sub-row-generated {
  display: grid;
  width: 100%;
  /* Columns and Gap are set inline by JS to match variables */
}

/* Each cluster of lights */
.sub-group {
  display: grid; 
  width: 100%;
  min-width: 0; /* Prevents overflow */
}

.sub-light {
  width: 100%; /* Stretch to fill slot */
  height: 32px;            
  border: 3px solid var(--black); 
  border-radius: 11px; /* Slightly tighter radius for small lights */
  background: var(--orange);
  cursor: pointer;
  touch-action: manipulation;
  transition: transform .05s, background .05s, filter .05s;
}

.sub-light.is-on { background: var(--orange); }
.sub-light.is-accent { background: var(--purple); }
.sub-light.is-muted { background: var(--blue-dim); opacity: 1; }
.sub-light.is-hit { transform: scale(1.05); filter: brightness(1.3); border-color: #fff; }

/* === Volume Card (Grid Layout) === */
.volume-card { display: flex; flex-direction: column; gap: 16px; }
.volume-block { display: contents; } 
.volume-row { display: flex; align-items: center; gap: 12px; width: 100%; }
.volume-card .metro-label { text-align: left; }
.volume-card .microtext { 
  flex: 0 0 5.2ch; 
  text-align: right; 
  font-variant-numeric: tabular-nums; 
  font-size: 0.95rem; 
}
.volume-card .slider-fill { flex: 1; min-width: 0; }

@media (min-width: 701px) {
  .volume-card {
    display: grid;
    grid-template-columns: auto minmax(0, 1fr) 5.2ch; /* Label | Slider | Value */
    column-gap: 20px; 
    row-gap: 16px; 
    align-items: center;
  }
  .volume-card .volume-row { display: contents; }
  .volume-card .metro-label { grid-column: 1; }
  #mainVolRange, #subVolRange { grid-column: 2; width: 100%; }
  #mainVolValue, #subVolValue { grid-column: 3; justify-self: end; }
}


/* === Settings Grid (Replaces old .control-lines) === */
.control-grid {
  display: grid;
  /* Auto-fit columns: Nice on desktop (3 cols), stacks on mobile (1 col) */
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px 30px; /* Row gap 20px, Col gap 30px */
  width: 100%;
  align-items: end; /* Align bottoms of inputs */
}

.setting-col {
  display: flex;
  flex-direction: column;
  gap: 8px; /* Space between Label and Input */
  width: 100%;
}

.setting-col .metro-label {
  text-align: left;
  margin-left: 2px;
  color: rgba(255, 255, 255, 0.9);
}

.input-group {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
}

/* Ensure selectors fill their containers */
.input-group .selector {
  width: 100%;
  text-align: left;
}

/* Time Signature Slash */
.metro-slash {
  font-size: 1.5rem;
  font-weight: 300;
  color: rgba(255, 255, 255, 0.7);
  padding-bottom: 2px;
}


/* === Picker Overlay (Modal) === */
.picker {
  position: fixed; inset: 0; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  
  /* CHANGED: Fixed 20px safety margin on all sides */
  padding: 20px;
  
  background: rgba(0, 0, 0, .35);
  backdrop-filter: blur(6px) saturate(120%); 
  -webkit-backdrop-filter: blur(6px) saturate(120%);
  z-index: 9999; 
  animation: picker-fade-in .18s ease-out;

  /* Dynamic height to respect keyboard */
  height: 100vh; 
  height: 100dvh; 
}

.picker[hidden] { display: none !important; }

.picker__panel {
  width: min(520px, 100%); 
  
  /* CHANGED: limit height to viewport so it fits above keyboard */
  max-height: 85vh;
  max-height: 85dvh;
  
  background: transparent; 
  border: none; 
  box-shadow: none; 
  padding: 0;
  
  display: flex;          /* CHANGED: Use Flex column */
  flex-direction: column; /* Stack Header + List */
  gap: 10px; 
  
  animation: panel-pop .22s cubic-bezier(.2, .8, .2, 1); 
  overscroll-behavior: contain;
}

.picker__header {
  /* Keep header rigid */
  flex: 0 0 auto;
  
  display: grid; 
  grid-template-columns: 1fr 40px; 
  grid-template-areas: "title close" "search search";
  align-items: center; 
  gap: 8px 10px; 
  padding: 8px; 
  border: 2px solid var(--black); 
  border-radius: 10px;
}
.picker--orange .picker__header { background: var(--orange); }
.picker__title { grid-area: title; margin: 0; font-size: 1.2rem; line-height: 1.2; color: #fff; }
.picker__close { 
  grid-area: close; width: 40px; height: 40px; 
  display: inline-flex; align-items: center; justify-content: center; 
  font-size: 1.4rem; line-height: 1; cursor: pointer; 
  background: #fff; color: #000; 
  border: 2px solid var(--black); border-radius: 10px; 
}
.picker__search { 
  grid-area: search; width: 100%; height: 40px; 
  font-size: 1rem; padding: 6px 12px; 
  background: #fff; color: #000; 
  border: 2px solid var(--black); border-radius: 10px; 
}

.picker__list {
  /* CHANGED: Allow list to shrink/scroll within the remaining space */
  flex: 1 1 auto; 
  min-height: 0; /* Important for flex scrolling */
  overflow-y: auto; 

  list-style: none; margin: 0; padding: 6px; 
  border: 2px solid var(--black); border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, .45);
  background: var(--orange);
}
.picker__item {
  padding: 10px 12px; cursor: pointer; color: #fff; 
  border-radius: 5px; transition: none; touch-action: manipulation;
}
@media (hover: hover) and (pointer: fine) {
  .picker__item:hover { background: var(--gray-3); }
}
.picker--orange .picker__item.is-active { background: #fff; color: var(--orange); }

/* Interaction guards */
.picker__list, .picker__item { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
.picker, .picker * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; caret-color: transparent; }
.picker .picker__search, .picker .picker__search * { -webkit-user-select: text !important; user-select: text !important; caret-color: auto !important; }

/* Animations */
@keyframes picker-fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes panel-pop { from { opacity: 0; transform: translateY(12px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

/* Disable hover on coarse pointers */
@media (hover: none) and (pointer: coarse) {
  .btn--orange:hover { background: var(--orange); }
  .btn--purple:hover { background: var(--purple); }
}
